# Overview of "IX: A Protected Dataplane Operating System for High Throughput and Low Latency"

搜索引擎、社交网络和电子商务等以数据处理为中心的应用模式中，软件由不同模块构成，并且部署于数以千记的节点中，这些节点间通过大量的短报文进行数据交换，这种应用模型对系统软件和网络协议栈提出了更高的要求：

-- 毫秒级延迟：为了向用户提供低延迟的服务，需要保证节点间毫秒级的数据交换，甚至是几十微秒级的数据交换。

-- 高速包处理：支持节点间的大量并发连接，且针对大量的小数据包交换具有良好的扩展性。

-- 隔离防护：保证应用间的安全隔离，一般利用kernel或hypervisor级网络协议栈实现应用间的隔离。

-- 资源效率：使用尽可能少的资源，以应对突发流量负载。

然而，通用的操作系统设计更趋向于硬件资源的共享和调度，因而牺牲了协议栈的效率，如中断处理、cpu调度、数据缓冲、驱动排队等都增加了数据包的处理延迟，限制了网络吞吐率的提高。因此，部分系统设计采取绕过系统协议栈，实现用户层协议栈的方法以减小Context切换开销，然后也并不能有效减少包的处理延时，同时也会因应用bug等问题导致协议栈crash。也有部分系统更进一步直接替换协议栈，采用RDMA直接互相访问彼此数据，但两端节点均需要安装特殊的网络适配器。

针对上述问题，本文作者提出了IX的设计架构，其优势在于：

-- 数据层和控制层的分隔和保护：基于硬件提供的虚拟化功能，将内核中负责资源配置、调度和监管功能作为控制层，将协议栈和数据处理逻辑作为数据层，实现控制层和数据层的分割。控制层负责对数据层的粗粒度资源调度，而数据层作为guest OS，自己进行内部的内存管理，利用ring0、ring3的特权级划分保障协议栈的安全性，同时，通过MMIO直接能够访问NIC进行数据收发。

-- Run to completion with adaptive batching：在数据层，将内核模式下的协议处理和用户模式下的应用逻辑，通过适应性的流水线划分，避免了中级处理过程的缓冲机制，处理过程一直保持run to completion。同时，在数据处理时通过利用轮询避免中断延迟，中断只用于调度控制。同时，在协议栈处理上实现批量化操作，提供cache的局部性，预取的有效性和分支预测的准确性。

-- Native、zero-copy API with explicit flow control：数据层中并未实现POSIX兼容接口，内核和应用通过消息进行交换，利用0拷贝减少包处理延时，应用直接在内存中设置分散DMA列表工NIC发送。

-- Flow consistent, synchroonization-free processing: 利用多队列的NIC卡功能，对数据流进行HASH区分，实现每个NIC服务一个收发队列，避免同步开销。

基于前述理论，作者在实现IX时将Linux内核运行于VMX root ring0，作为hypervisor(控制层)；D通过插入Dune模块以在VMX non-root ring0运行虚拟化Guest OS(libDune)；应用运行于VMX non-root ring3。这种模式让数据层能够直接访问硬件设备，例如页表、直写NIC等；同时也基于虚拟化机制保证了控制层、数据层和不可信应用间的隔离。

通过测试，IX在延迟、吞吐量、并发数等方面都极大超过了Linux和mTCP，性能方面超过mTCP 1.9倍，超过Linux 8.8倍。