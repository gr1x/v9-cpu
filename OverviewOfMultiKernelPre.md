# Your computer is already a distributed system. Why isn't your OS?

[论文原文](http://www.barrelfish.org/barrelfish_hotos09.pdf)

传统的商用操作系统设计模型基于一个静态、单一的CPU体系架构和内存结构，然而，随着硬件技术的不断发展，多核CPU不同核心可以具有不同的指令集，GPU和NIC等逐步具有更强大的计算能力和可编程性，同时FPGA也开始被集成到CPU中，因此，由这些不同硬件组成的计算机系统架构越来越趋向于成为一个分布式系统，异构的节点间需要进行数据交互，且要求缩短节点间通信延时；同时，热插拔、虚拟化和电源管理等让CPU、内存、IO外设等硬件部件在运行时动态增减。这些变化都对传统的OS设计提出了挑战。虽然，传统OS可以逐步演进完善于面对上述硬件架构变化，但“Your computer is already a distributed system. Why isn't your OS?”这篇文章的作者认为，针对计算机底层硬件结构分布式发展的趋势，需要重新考虑传统的OS设计架构，抛弃过去的传统巨内核架构，重新从底层设计一个与硬件结构吻合的分布式操作系统。

文中提出分布式OS设计主要的关注点有：
- 消息传递与共享内存：传统的OS中利用共享内存的数据结构实现数据交换，但存在访问同步的开销，随着CPU核数的增加，锁的争用愈显频繁，导致性能反而随核数增加而下降；若将通信数据封装在消息中在多核间传递，将能有效避免数据争用，同时也能适配不同的异构核。
- Replication：为了解决数据争用的扩展性问题，OS需要将Replication作为默认的数据访问模型，即为每一个核都复制一份数据，同时针对数据同步问题设计一个同步协议（分阶段异步发出数据修改通告，等待修改的确认或拒绝）；在Replication基础上优化时，再引入共享和锁机制。
- 一致性：内存映射、文件IO、网络等对数据的一致性及同步顺序有着不同的要求，通过对一致性的同步数据设置明确的限制规则，以按步骤顺序进行更新同步，以避免对关键区域进行锁机制同步等开销。
- 网络效应：数据路由、拥塞和排队这些网络概念已成为计算机架构设计必须考虑的问题，如从网络接收并将返回网络的数据应尽量存放于靠近NIC的位置，需DMA到内存的数据应尽量靠近CPU core。
- 异构性：底层CPU、NIC、GPU、Brige等不同主控的异构性需通过标准化的消息协议机制进行数据通信，在分布式服务的基础上提高逻辑上的抽象软件接口。

在分析基础上，作者设计了multikernel的操作系统结构，为了验证将计算机结构视为分布式网络的设计效果，作者摈弃了POSIX等兼容接口，以重新设计适应新型硬件、调度规则和IO要求的接口；同时，避免了跨核的数据共享，利用异步的消息机制进行数据通信；通过数据复制和分阶段同步交互实现数据一致性；以及进行底层硬件抽象，屏蔽异构的差异。

